<html>
	<head>
		<title>RECON Remastered</title>
	</head>
	<body>
		<div id="Content">
			<div id="DivWorkspace" style="border: 2px solid #000000; overflow: scroll; background-color: #C0C0C0;">
				<canvas id="Workspace" style="background-color: #FFFFFF;" ondrop="EvtOnDrop(event)" ondragover="EvtOnDragOver(event)" onclick="EvtOnDraw(event)"></canvas>
			</div>
			<div id="Devspace" style="border: 2px solid #0000FF; height: 70px;">
				<img id="DeviceRouter" src="images/Router.png" onclick="AddToWorkspace(this)" draggable="true" ondragstart="EvtOnDragStart(this)">
				<img id="DeviceSwitch" src="images/Switch.png" onclick="AddToWorkspace(this)" draggable="true" ondragstart="EvtOnDragStart(this)">
				<img id="DeviceServer" src="images/Server.png" onclick="AddToWorkspace(this)" draggable="true" ondragstart="EvtOnDragStart(this)">
				<img id="DeviceTerminal" src="images/Terminal.png" onclick="AddToWorkspace(this)" draggable="true" ondragstart="EvtOnDragStart(this)">
				
				<img id="CableLan" src="images/lan.png" draggable="false" onclick="EvtOnClick(this)">
				<img id="CableWan" src="images/wan.gif" draggable="false" onclick="EvtOnClick(this)">
				<img id="CableConsole" src="images/console.png" draggable="false" onclick="EvtOnClick(this)">
				
			</div>
			<button type="button" onclick="PrintAllDevices(this)">Print All Devices</button>For now, you can remove devices on the workspace on right click<br>
			<font id="Output"></font>
		</div>
		
				
		
		<script>
			var Content = document.getElementById("Content");
			var CnvsWorkspace = document.getElementById("Workspace");
			var Workspace = CnvsWorkspace.getContext("2d");
			var Devspace = document.getElementById("Devspace");
			var Output = document.getElementById("Output");

			var DevRouter = { id:"DeviceRouter", name:"Router", image:"images/Router.png", height:38, width:64, count: 0};
			var DevSwitch = { id:"DeviceSwitch", name:"Switch", image:"images/Switch.png", height:38, width:64, count: 0};
			var DevServer = { id:"DeviceServer", name:"Server", image:"images/Server.png", height:64, width:44, count: 0};
			var DevTerminal = { id:"DeviceTerminal", name:"Terminal", image:"images/Terminal.png", height:54, width:62, count: 0};

			var Devices = [];
			var DeviceTypes = [];
			
			DeviceTypes.push(DevRouter);
			DeviceTypes.push(DevSwitch);
			DeviceTypes.push(DevServer);
			DeviceTypes.push(DevTerminal);
			
		// START TESTING
			
			var CabLan = { id:"CableLan", name:"LAN", image:"images/lan.png", height:54, width:62, count: 0};
			var CabWan = { id:"CableWan", name:"WAN", image:"images/wan.gif", height:54, width:62, count: 0};
			var CabConsole = { id:"CableConsole", name:"CONSOLE", image:"images/console.png", height:54, width:62, count: 0};
			
			var Cables = []; 
			var CableTypes = [];
			
			CableTypes.push(CabLan);
			CableTypes.push(CabWan);
			CableTypes.push(CabConsole);
			
			var ClickedCable = null;
			var CableChoice = "";
			
			var canvas = document.getElementById('Workspace');
			var context = canvas.getContext('2d');
			
			var counter=2;
			
		// END TESTING

			Content.height = window.innerHeight;
			Content.width = window.innerWidth;
			CnvsWorkspace.height = Content.height - 150;//500;
			CnvsWorkspace.width = Content.width - 37;//1000;
			Workspace.font="16px Calibri";
			Workspace.textAlign="center";

			var CnvsDimension = CnvsWorkspace.getBoundingClientRect();
			var MouseX = CnvsDimension.left;
			var MouseY = CnvsDimension.top;
			var DraggingDeviceNum = 0;
			var IsDragging = false;
			var DraggingDevice = null;
			var DraggingDevicePtX = 0;
			var DraggingDevicePtY = 0;
			var DraggingDevicePtXtwo = 0;
			var DraggingDevicePtYtwo = 0;
			
			
			var IsDropping = false;
			var DraggedDevice = null;
			var DraggedDevicePosX = 0;
			var DraggedDevicePosY = 0;
			

			CnvsWorkspace.onmousedown = EvtMouseDown;
			CnvsWorkspace.onmouseup = EvtMouseUp;
			CnvsWorkspace.oncontextmenu = RemoveOnRightClick;

			
			
			function AddToWorkspace(arg){
				var NewDeviceIcon = new Image();
				var RefDevice = DeviceTypes[SearchDeviceTypeIdFromElementId(arg.id)];
				RefDevice.count++;
				var TempDevice = JSON.parse(JSON.stringify(RefDevice));
				TempDevice.name = TempDevice.name + " " + RefDevice.count;
				NewDeviceIcon.src = TempDevice.image;
				var PosX = 0;
				var PosY = 0;
				NewDeviceIcon.onload = function(){
					Workspace.drawImage(NewDeviceIcon, PosX, PosY);
					Workspace.fillText(TempDevice.name, PosX + TempDevice.width / 2, PosY + TempDevice.height + 20);
				}
				var NewDevice = { object:NewDeviceIcon, x:PosX, y:PosY, height:TempDevice.height, width:TempDevice.width, name:TempDevice.name};

				Devices.push(NewDevice);
			}
			
			function RemoveOnRightClick(arg){
				arg.preventDefault();
				
				MouseX = arg.clientX - CnvsDimension.left;
				MouseY = arg.clientY - CnvsDimension.top;

				DraggingDeviceNum = SearchTopDeviceIdOnMousePosition(MouseX, MouseY);
				
				if(DraggingDeviceNum >= 0){
					
					if(RemovePrompt("device")==true){
						WorkspaceRemove();
						Devices.splice(DraggingDeviceNum, 1);
						WorkspaceRepaint();
					}
					
				}
				else if (CheckForCables(MouseX,MouseY) != -1){
					
					if(RemovePrompt("cable")==true){
						WorkspaceRemove();
						Cables.splice(CheckForCables(MouseX,MouseY),1);
						WorkspaceRepaint();
					}
					
					
				}
				return false;
			}
			
			
			function RemovePrompt(removetype) {
				
				var choice;
				if(removetype=="device"){
					choice = Devices[DraggingDeviceNum].name;
				}
				else{
					choice = Cables[CheckForCables(MouseX,MouseY)].name;
				}
				
				if(confirm("Are you sure you want to remove " + choice + "?") == true){
					return true;
				}
				else 
					return false;
			}
			
			function CheckForCables(mousex, mousey){
			
				var found;
				var slope;
				var stepone;
				var steptwo;
				var answer;
			
				var x;
				var y;
				
				found=-1;
				
				for(var nCtr = 0; nCtr < Cables.length && found < 0; nCtr++){
					
					slope= (Cables[nCtr].endpointy - Cables[nCtr].startpointy) / (Cables[nCtr].endpointx - Cables[nCtr].startpointx);
					
					x=Cables[nCtr].startpointx;
					y=Cables[nCtr].startpointy;
						
					// POINT SLOPE EQUATION: y - y1 = m(x-x1)
					stepone=y-mousey;
					steptwo=slope*(x-mousex);
					
					if(stepone < 0){
						stepone=stepone*(-1);
						steptwo=steptwo*(-1);
					}
					
					/* // For Checking
					console.log("Slope: " + slope);
					console.log("Stepone: " +stepone);
					console.log("Steptwo: " +steptwo);
					console.log("found: " + found);
					*/
					
					if(stepone>=steptwo){
						answer=stepone-steptwo;
					}
					else{
						answer=steptwo-stepone;
					}
					
					if(answer < 8){
						found=nCtr;
					}
						
				}
				
				if(found != -1){
					return found;
				}
				else
					return -1;
					
			}
			
			function SearchCableTypeIdFromElementId(ID){
				var found = false;
				var nCtr = 0;
				while(nCtr < CableTypes.length && found == false){
					if(CableTypes[nCtr].id == ID){
						found = true;
					} else {
						nCtr++;
					}
				}
				if(found)
					return nCtr;
				else
					return -1;
			}

			function SearchDeviceTypeIdFromElementId(ID){
				var found = false;
				var nCtr = 0;
				while(nCtr < DeviceTypes.length && found == false){
					if(DeviceTypes[nCtr].id == ID){
						found = true;
					} else {
						nCtr++;
					}
				}
				
				if(found)
					return nCtr;
				else
					return -1;
			}
			
			function SearchTopDeviceIdOnMousePosition(MouseX, MouseY){
				var found = false;
				var nCtr = Devices.length - 1;
				while(nCtr >= 0 && found == false){
					if(MouseX >= Devices[nCtr].x &&
						MouseX <= Devices[nCtr].x + Devices[nCtr].width &&
						MouseY >= Devices[nCtr].y &&
						MouseY <= Devices[nCtr].y + Devices[nCtr].height){
						found = true;
						DraggingDevicePtX = MouseX - Devices[nCtr].x;
						DraggingDevicePtY = MouseY - Devices[nCtr].y;
					} else {
						nCtr--;
						
					}
				}
				if(found)
					return nCtr;
				else
					return -1;
			}
			
			

			function EvtMouseDown(arg){
				CnvsDimension = CnvsWorkspace.getBoundingClientRect();
				
					MouseX = arg.clientX - CnvsDimension.left;
					MouseY = arg.clientY - CnvsDimension.top;
						
					DraggingDevicePtX = 0;
					DraggingDevicePtY = 0;
					DraggingDeviceNum = SearchTopDeviceIdOnMousePosition(MouseX, MouseY);
					
				if(DraggingDeviceNum != -1){
					IsDragging = true;
					
					CnvsWorkspace.onmousemove = EvtMouseMove;
				}
				
			}

			function EvtMouseUp(arg){
				if(IsDragging){
					IsDragging = false;
					DraggingDeviceNum = 0;
					CnvsWorkspace.onmousemove = null;
					
				}
			}

			function EvtMouseMove(arg){
				WorkspaceRemove();

				MouseX = arg.clientX - CnvsDimension.left;
				MouseY = arg.clientY - CnvsDimension.top;
				Devices[DraggingDeviceNum].x = MouseX - DraggingDevicePtX;
				Devices[DraggingDeviceNum].y = MouseY - DraggingDevicePtY;
				
				dragdevice = String(Devices[DraggingDeviceNum].name);
				dragdevice = dragdevice.substr(0,dragdevice.indexOf(' '));
				
				var dragslopex;
				var dragslopey;
				
				var dragdevicex=MouseX-DraggingDevicePtX; 
				var dragdevicey=MouseY-DraggingDevicePtY;
				
				for(var nCtr = 0; nCtr < Cables.length; nCtr++){
					if(DraggingDeviceNum == Cables[nCtr].startdevice){
					
						dragslopex= (Cables[nCtr].endpointx - dragdevicex); 
						dragslopey=	(Cables[nCtr].endpointy - dragdevicey);
						
						var dragdevicex=MouseX-DraggingDevicePtX+ConnectAid(dragdevice,1,dragslopex,dragslopey);
						var dragdevicey=MouseY-DraggingDevicePtY+ConnectAid(dragdevice,2,dragslopex,dragslopey);
						
						Cables[nCtr].startpointx=dragdevicex;
						Cables[nCtr].startpointy=dragdevicey;
					}
					else if(DraggingDeviceNum == Cables[nCtr].enddevice){
					
						dragslopex= (Cables[nCtr].startpointx - dragdevicex); 
						dragslopey=	(Cables[nCtr].startpointy - dragdevicey);
						
						var dragdevicex=MouseX-DraggingDevicePtX+ConnectAid(dragdevice,1,dragslopex,dragslopey);
						var dragdevicey=MouseY-DraggingDevicePtY+ConnectAid(dragdevice,2,dragslopex,dragslopey);
					
						Cables[nCtr].endpointx =dragdevicex;
						Cables[nCtr].endpointy =dragdevicey;
					} 
				}
				counter=2;
				CableChoice="";
				WorkspaceRepaint();
				
			}

			function EvtOnDragStart(arg){
				DraggedDevice = arg;
				DraggedDevicePosX = event.clientX - DraggedDevice.getBoundingClientRect().left;
				DraggedDevicePosY = event.clientY - DraggedDevice.getBoundingClientRect().top;
				IsDropping = true;
			}
			
			function EvtOnClick(arg){
					
					ClickedCable = arg;
					
					var RefCable = CableTypes[SearchCableTypeIdFromElementId(arg.id)];
					var TempCable = JSON.parse(JSON.stringify(RefCable));
						
					if(TempCable.name == "LAN"){
					CableChoice="LAN";
					}
					else if(TempCable.name== "WAN"){
					CableChoice="WAN";
					}	
					else{
					CableChoice="CONSOLE";
					}
					// console.log(CableChoice); // <TO TRACE CABLE CHOSEN	
				}
				
			
			function ConnectAid(device,key,slopex,slopey){
			
				var aidx;
				var aidy;
				
				aidx=0;
				aidy=0;
				
				
				// console.log("SLOPE: " + slopey + "/" + slopex ); // <USED TO TRACE
				
				if(device=="Terminal"){
							aidx=31
							aidy=27
					} 
				else if(device=="Server"){
							aidx=22;
							aidy=32;
					}
				else{
							aidx=32;
							aidy=19;
					}  
				
					if(key==1)
						return aidx;
					else
						return aidy;		
			}

			var MouseXTwo = CnvsDimension.left;
			var MouseYTwo = CnvsDimension.top;

			function EvtOnDraw(arg){
			
				  if(counter%2!=0 && CableChoice!="" &&  SearchTopDeviceIdOnMousePosition(MouseX, MouseY) >= 0 && SearchTopDeviceIdOnMousePosition(MouseXTwo, MouseYTwo) >= 0  && SearchTopDeviceIdOnMousePosition(MouseX, MouseY) != SearchTopDeviceIdOnMousePosition(MouseXTwo, MouseYTwo)){
				  
					var firstx;
					var firsty;
					var firstdevice;
					
					var slopex;
					var slopey;
					
					firstdevice = String(Devices[SearchTopDeviceIdOnMousePosition(MouseXTwo,MouseYTwo)].name)
					firstdevice = firstdevice.substr(0,firstdevice.indexOf(' '));
					
					slopex= MouseX-MouseXTwo;
					slopey= MouseY-MouseYTwo;
					
					firstx=MouseXTwo-DraggingDevicePtX+ConnectAid(firstdevice,1,slopex,slopey);
					firsty=MouseYTwo-DraggingDevicePtY+ConnectAid(firstdevice,2,slopex,slopey);
					
				    context.beginPath();
					context.moveTo(firstx, firsty);
					context.lineWidth=5;
					context.lineCap = "round";
					 
					var secondx;
					var secondy;
					var seconddevice;
						
					seconddevice = String(Devices[SearchTopDeviceIdOnMousePosition(MouseX,MouseY)].name)
					seconddevice = seconddevice.substr(0,seconddevice.indexOf(' '));
				
					slopex= MouseXTwo-MouseX;
					slopey= MouseYTwo-MouseY;
				
					secondx=MouseX-DraggingDevicePtX+ConnectAid(seconddevice,1,slopex,slopey);
					secondy=MouseY-DraggingDevicePtY+ConnectAid(seconddevice,2,slopex,slopey);
			
					 if(CableChoice == "LAN"){
					 
						context.strokeStyle = '#000000';	
						context.lineTo(secondx, secondy);
						context.stroke();
					 }
					 else if(CableChoice == "WAN"){
								
								var startX = firstx;
								var startY = firsty;
							
								endX = secondx;
								endY = secondy;

								var DifX = 0;
								var DifY = 0;
								if(endX > startX)
									DifX = endX - startX
								else
									DifX = startX - endX
								if(endY > startY)
									DifY = endY - startY
								else
									DifY = startY - endY

								if(startX - endX > 0)
									DifX = -DifX
								if(startY - endY > 0)
									DifY = -DifY

								context.strokeStyle = '#ff0000';
								Workspace.lineTo(startX + DifX / 2 + 10, startY + DifY / 2 + 10);	
								Workspace.lineTo(startX + DifX / 2 - 10, startY + DifY / 2 - 10);
								Workspace.lineTo(secondx, secondy);
								Workspace.stroke();
					 }
					 else if(CableChoice == "CONSOLE"){
						context.strokeStyle = '#5bfcff';	
						context.bezierCurveTo(firstx,firsty-20,secondx,secondy-20,secondx,secondy);
						context.stroke();
					 
					 }
					 
					 WorkspaceRepaint();
					 var firstd = SearchTopDeviceIdOnMousePosition(MouseXTwo,MouseYTwo);
					 var secondd = SearchTopDeviceIdOnMousePosition(MouseX,MouseY);
					 
					 addCable(firstx,firsty,secondx,secondy,firstd,secondd);
					 
					 console.log("Point 2: " + firstx+","+firsty);
					 console.log("Point 1: " +secondx+","+secondy);
					 console.log("Last picked: "+CableChoice);
					 // console.log("counter: " +counter);
					 
					 counter++;
				}
				else if(SearchTopDeviceIdOnMousePosition(MouseX, MouseY) >= 0 && CableChoice!=""){
				  
				    MouseXTwo = MouseX;
					MouseYTwo = MouseY;
					
					counter++;
 
				  }
				  
				  // console.log("checker: " + MouseX +","+MouseY);  // << FOR CHECKING COORDINATES
			}
			
			function addCable(firstxpoint, firstypoint, secondxpoint, secondypoint,firstdevice,seconddevice){
					var RefCable = CableTypes[SearchCableTypeIdFromElementId(ClickedCable.id)]
					RefCable.count++;
					
					var TempCable = JSON.parse(JSON.stringify(RefCable));
					TempCable.name = TempCable.name + " " + RefCable.count;
					
					var NewCable = {startpointx: firstxpoint, startpointy: firstypoint, endpointx: secondxpoint, endpointy: secondypoint, startdevice: firstdevice, enddevice: seconddevice ,name:TempCable.name};
					Cables.push(NewCable);
				
			}
				
			function EvtOnDrop(arg) {
				arg.preventDefault();
				if(IsDropping == true){
					IsDropping = false;
					var NewDeviceIcon = new Image();
					var RefDevice = DeviceTypes[SearchDeviceTypeIdFromElementId(DraggedDevice.id)];
					RefDevice.count++;
					var TempDevice = JSON.parse(JSON.stringify(RefDevice));
					TempDevice.name = TempDevice.name + " " + RefDevice.count;
					NewDeviceIcon.src = TempDevice.image;
					var PosX = arg.clientX - CnvsDimension.left - DraggedDevicePosX;
					var PosY = arg.clientY - CnvsDimension.top - DraggedDevicePosY;
					NewDeviceIcon.onload = function(){
						Workspace.drawImage(NewDeviceIcon, PosX, PosY);
						Workspace.fillText(TempDevice.name, PosX + TempDevice.width / 2, PosY + TempDevice.height + 20);
					}
					var NewDevice = { object:NewDeviceIcon, x:PosX, y:PosY, height:TempDevice.height, width:TempDevice.width, name:TempDevice.name};
					Devices.push(NewDevice);
					
					CableChoice="";
					counter=2;
					
				}
			}

			function EvtOnDragOver(arg){
				arg.preventDefault();
			}

			function PrintAllDevices(arg){
				Output.innerHTML = "";
				for(var nCtr = 0; nCtr < Devices.length; nCtr++){
					Output.innerHTML += "Device " + (nCtr + 1) + " is " + Devices[nCtr].name + "<br>";
				}
				
				for(var nCtr = 0; nCtr < Cables.length; nCtr++){
					Output.innerHTML += "Cable " + (nCtr + 1) + " is " + Cables[nCtr].name + "<br>";
				}
				
			}

			function WorkspaceRemove(arg){
				for(var nCtr = 0; nCtr < Devices.length; nCtr++){
					Workspace.clearRect(Devices[nCtr].x - 1, Devices[nCtr].y - 1, Devices[nCtr].width + 2, Devices[nCtr].height + 2);
					Workspace.clearRect(Devices[nCtr].x - 20, Devices[nCtr].y + Devices[nCtr].height, 120, 40);
				}
				for(var nCtr = 0; nCtr < Cables.length; nCtr++){
				
					 context.beginPath();
					 context.moveTo(Cables[nCtr].startpointx, Cables[nCtr].startpointy);
					 context.lineWidth=10;
					 context.lineCap = "round";
					 context.strokeStyle = '#FFFFFF';
					 
					 if((Cables[nCtr].name).substr(0,3) == "LAN"){
							
						context.lineTo(Cables[nCtr].endpointx, Cables[nCtr].endpointy);
						context.stroke();
					 }
					 else if((Cables[nCtr].name).substr(0,3) == "WAN"){
								var startX = Cables[nCtr].startpointx;
								var startY = Cables[nCtr].startpointy;
							
								endX = Cables[nCtr].endpointx;
								endY = Cables[nCtr].endpointy;

								var DifX = 0;
								var DifY = 0;
								if(endX > startX)
									DifX = endX - startX
								else
									DifX = startX - endX
								if(endY > startY)
									DifY = endY - startY
								else
									DifY = startY - endY

								if(startX - endX > 0)
									DifX = -DifX
								if(startY - endY > 0)
									DifY = -DifY

								Workspace.lineTo(startX + DifX / 2 + 10, startY + DifY / 2 + 10);	
								Workspace.lineTo(startX + DifX / 2 - 10, startY + DifY / 2 - 10);
								Workspace.lineTo(Cables[nCtr].endpointx, Cables[nCtr].endpointy);
								Workspace.stroke();
					 }
					else{	
						context.bezierCurveTo(Cables[nCtr].startpointx,Cables[nCtr].startpointy-20,Cables[nCtr].endpointx,Cables[nCtr].endpointy-20,Cables[nCtr].endpointx,Cables[nCtr].endpointy);
						context.stroke();
					}
				}
				
			}

			function WorkspaceRepaint(arg){
			
				for(var nCtr = 0; nCtr < Cables.length; nCtr++){
					 context.beginPath();
					 context.moveTo(Cables[nCtr].startpointx, Cables[nCtr].startpointy);
					 context.lineWidth=5;
					 context.lineCap = "round";
					 
					 if((Cables[nCtr].name).substr(0,3) == "LAN"){
						context.strokeStyle = '#000000';	
						context.lineTo(Cables[nCtr].endpointx, Cables[nCtr].endpointy);
						context.stroke();
					 }
					 else if((Cables[nCtr].name).substr(0,3) == "WAN"){
						context.strokeStyle = '#ff0000';	
						
						var startX = Cables[nCtr].startpointx;
						var startY = Cables[nCtr].startpointy;
							
						endX = Cables[nCtr].endpointx;
						endY = Cables[nCtr].endpointy;

						var DifX = 0;
						var DifY = 0;
						if(endX > startX)
							DifX = endX - startX
						else
							DifX = startX - endX
						if(endY > startY)								
							DifY = endY - startY
						else
							DifY = startY - endY

						if(startX - endX > 0)
							DifX = -DifX
						if(startY - endY > 0)
							DifY = -DifY

						Workspace.lineTo(startX + DifX / 2 + 10, startY + DifY / 2 + 10);	
						Workspace.lineTo(startX + DifX / 2 - 10, startY + DifY / 2 - 10);
						Workspace.lineTo(Cables[nCtr].endpointx, Cables[nCtr].endpointy);
						Workspace.stroke();
					 }
					 else{
						context.strokeStyle = '#5bfcff';	
						context.bezierCurveTo(Cables[nCtr].startpointx,Cables[nCtr].startpointy-20,Cables[nCtr].endpointx,Cables[nCtr].endpointy-20,Cables[nCtr].endpointx,Cables[nCtr].endpointy);
						context.stroke();
					 }	
				}
			
				for(var nCtr = 0; nCtr < Devices.length; nCtr++){
					Workspace.drawImage(Devices[nCtr].object, Devices[nCtr].x, Devices[nCtr].y);
					Workspace.fillText(Devices[nCtr].name, Devices[nCtr].x + Devices[nCtr].width / 2, Devices[nCtr].y + Devices[nCtr].height + 20);
				}
				
				
					
				
			}
		</script>
	</body>
</html>